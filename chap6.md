# chapter 6 시스템 자료 파일과 시스템

## 6.2 패스워드 파일

UNIX 시스템들은 패스워드 파일을 /etc/passwd에 ASCII 형태로 저장해 왔다. </br>
보통의 경우 패스워드 파일에는 사용자 이름이 root인 항목이 존재한다. </br>
암호화된 패스워드 필드에 문자 하나만 들어있다. 암호화된 패스워드를 누구나 읽을 수 있으면 보안상 문제가 생길 수 있기 때문에 요즘에는 암호화된 패스워드를 다른 파일에 저장하고 패스워드 파일의 해당 부분에는 그냥 문자 하나만 기록해둔다. </br>
패스워드 파일 항목의 일부 필드들은 비어 있을 수 있다. 암호화된 패스워드가 비어 있다면, 일반적으로 그것은 해당 사용자 계정에 패스워드가 없다는 것이다. </br>
셸 필드에는 사용자의 로그인 셸로 쓰이는 실행 가능 프로그램의 이름이 담긴다. 셸 필드가 비어 있는 경우, 기본적으로 쓰이는 프로그램은 /bin/sh이다. 그런데 squid 줄의 셸 필드에는 /dev/null이 지정되어 있다. </br>
/dev/null 이외에 특정 사용자의 로그인 방지를 위해 쓰이는 기법은 로그인 셸로 /bin/false를 지정하는 방법도 있는데, 이는 성공적이지 못한 종료 상태를 반환하는 것이 유일한 용도인 프로그램이다. </br>
비슷하게 항상 성공에 해당하는 종료 상태를 돌려주는 /bin/true도 그런 목적으로 쓰인다. </br>
nobody라는 사용자 이름은 누구나 시스템에 로그인할 수 있게 하는 데 쓰인다. 단, 이 이름으로 로그인 한 사용자에게는 어떠한 특권도 없는 사용자 ID(65534)와 그룹 ID(65534)가 배정된다. 이 사용자 ID와 그룹 ID로는 기타 계정이 읽거나 쓸 수 있는 파일들만 읽거나 쓸 수 있다. </br>
finger(1) 명령을 지원하는 몇몇 시스템들은 주석 필드 안에 추가적인 정보를 설정할 수 있게 한다. 시스템이 finger 명령을 지원하지 않는다고 해도 주석 필드에 정보를 집어 넣는 일은 얼마든지 가능하다.

관리자가 패스워드 파일을 안전하게 수정할 수 있도록 vipw 명령을 제공하는 시스템들도 있다. </br>
vipw 명령은 패스워드 파일에 대한 변경들을 직렬화하며, 파일의 변경 내용이 시스템의 다른 자료 파일들에 적절히 반영되도록 만든다. 또한 비슷한 기능성을 그래픽 사용자 인터페이스를 통해서 제공하는 시스템들도 많이 있다.

POSIX.1에서 패스워드 파일의 항목들을 조회하는데 쓰이는 함수는 단 두가지이다. 이 함수들은 사용자의 로그인 이름이나 수치 사용자 ID를 돌려준다.
    #include <pwd.h>

    struct passwd *getpwuid(uid_t uid);
    struct passwd *getpwnam(const char *name);
getpwuid 함수는 예를 들어 ls 프로그램이 파일 i노드에 담긴 수치적 사용자 ID로부터 그에 해당하는 사용자 로그인 이름을 얻을 때 쓰인다. </br>
getpwnam 함수는 예를 들어 login 프로그램에서 사용자가 로그인 이름을 입력할 때 쓰인다. </br>
두 함수가 모두 정보가 기록된 passwd 구조체를 가리키는 포인터를 돌려준다. 보통의 경우 이 구조체는 함수 내부의 static 변수이므로, 함수를 다시 호출하면 그 내용이 갱신된다. </br>
이 두 POSIX.1 함수들은 특정한 로그인 이름이나 사용자 ID 중 하나를 알고 있는 상황에서 그에 해당하는 사용자 ID나 로그인 이름을 알아내고자 할 때 유용하다. </br>
그러한 사전 지식 없이 패스워드 파일에 담긴 정보들을 차례로 훑고 싶을 때는 다음 세 함수들을 사용해야 한다. 
    #include <pwd.h>

    struct passwd *getpwent(void);
    void setpwent(void);
    void endpwent(void);
getpwent 함수는 패스워드 파일의 다음 항목들을 돌려준다. 자신이 정보를 채운 구조체를 가리키는 포인터를 돌려준다. 그 구조체는 함수가 호출될 때마다 갱신된다. </br>
첫 호출시 getpwent는 자신의 작업에 필요한 파일을 연다. 그런데 이 함수가 돌려주는 항목들의 순서에 대해서는 어떠한 보장도 없다. 이는 /etc/passwd 파일의 내용을 hashing해서 사용하는 시스템들이 있기 때문이다. </br>
setpwent 함수는 해당 파일을 되감으며, endpwent 함수는 그 파일들을 닫는다. getpwent 함수를 다 사용했으면 반드시 endpwent로 파일들을 닫아야 한다. 

(ex1) 함수 시작 부분에서는 setpwent를 호출해서 파일들을 되감는다. 이는 호출자가 getpwent를 호출해서 이미 파일들을 열어둔 경우를 대비한 것이다. </br>
마찬가지로 함수 끝 부분에서는 endpwent를 호출해서 파일들을 닫는다. getpwnam이나 getpwuid 모두 파일들을 열어둔 채로 남겨두어서는 안되기 때문이다. 

## 6.3 그림자 패스워드

암호화된 패스워드는 사용자의 패스워드를 단방향 암호화 알고리즘으로 암호화한 것이다. 알고리즘이 단방향이므로, 암호화된 패스워드로부터 원래의 패스워드를 추측할 수는 없다.
Linux 2.4.22와 Solaris 9는 그림자 패스워드 파일에 접근하기 위한 개별적인 함수들을 제공한다. 이들은 패스워드 파일에 접근하는데 쓰이는 함수들과 비슷하다. 
    #include <shadow.h>

    struct spwd *getspnam(const char *name);
    struct spwd *getspent(void);
    void setspent(void);
    void endspent(void);

## 6.4 그룹 파일

gr_mem 필드는 해당 그룹에 속한 사용자 이름들을 가리키는 포인터들의 배열이다. 이 배열의 마지막 원소는 널 포인터이다. </br>
그룹 이름이나 수치 그룹 ID를 조회할 때에는 다음 두 함수를 사용한다.
    #include <grp.h>

    struct group *getgrgid(gid_t gid);
    struct group *getgrnam(const char *name);
